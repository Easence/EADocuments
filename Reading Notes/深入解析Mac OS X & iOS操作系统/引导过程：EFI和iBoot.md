# 读书笔记之引导过程：EFI和iBoot

标签（空格分隔）： 《OSX&iOS内核》 读书笔记

---
[TOC]

##什么是引导过程
引导过程指的是：从计算机通电的那一瞬间到CPU开始执行操作系统代码时的整个过程。整个过程大概是这样子的：

1. 刚通电的时候，BIOS或者固件会加载一些自举代码（bootstrap）给CPU，这些代码会探测各种存在设备。
2. 接着寻找引导磁盘，在引导磁盘的活动分区的第一个扇区找到`操作系统加载器`。由于BIOS的局限性，只支持一个操作系统的加载，如果需要安装多个操作系统，则要接住第三方的引导加载（如：GRUB），来提供操作系统的选择菜单。
3. 由操作系统加载器加载操作系统代码。

## EFI（Extensible Firmware Interface，可扩展固件接口）

### BIOS的局限性
- BIOS只能访问1M的内存。例如：在启动windows的时候，会发现开始的时候分辨率极低，在windows的logo出来以后才恢复正常。
- 只允许4个可引导分区（或称为主分区）。

### EFI的概念
正因为BIOS的局限性，EFI应运而生。EFI是一套接口，它规范了一组应用程序编程的接口。基于EFI开发的程序通常都是引导加载器（如：基于Linux的GRUB，苹果的boot.efi和Boot Camp），但也可以是一些诊断程序（如：苹果的硬件测试工具），甚至还可以是编译时链接了EFI API的普通程序。
> EFI自下而上的架构大概是：硬件->固件（包含：EFI引导服务和EFI运行时服务）->EFI二进制文件（EFI引导加载器）->软件

### EFI提供的服务

#### EFI引导服务
当系统仍然在EFI环境中，并且没有调用`ExitBootServices()`这个特殊的函数之前，可以访问引导服务。它提供了对内存、硬件的访问，还支持加载EFI程序，此时的资源都被认为归固件所有。一旦调用了`ExitBootServices()`,引导服务就无法访问了。

对于硬件的访问，EFI定义了协议的概念，每个协议都是一个唯一的128位的GUID，它封装了和某个特定设备或某一类设备相关的API。这些协议有：

- **控制台协议**（控制负责用户输入输出的设备，如：键盘、鼠标、串口、屏幕以及其他一些更复杂的设备）
- **媒介访问**（和文件系统打交道）
- **杂项协议**（）

#### EFI运行时服务
跟引导服务一样可以运行在EFI模式下，但是跟引导不同之处在于，运行时服务在退出EFI模式依然可以使用。不过运行时服务不能提供引导服务所提供的各种服务。只包含一下这些服务：

- 时间管理
- 闹钟
- 固件变量
- 其他杂项

## MAC的boot.efi

## iOS的iBoot
iOS的引导是苹果独创的，构成如图1所示，起引导过程分两条主线：

- **普通引导、恢复模式引导**
- **DFU模式引导**

![图1](https://github.com/Easence/EADocuments/blob/master/Reading%20Notes/深入解析Mac%20OS%20X%20&%20iOS操作系统/Resources/Images/The%20iOS%20Boot%20Progress.png?raw=true)

整个引导过程大概是这样的：
1. 首先加载Boot ROM。(只有这一步骤是未加密的，其他的步骤是都是加密的)
2. 接着判断是否是DFU模式，是则跳到步骤4，否则跳到步骤3。
3. 

### 普通引导
### 恢复模式引导
### DFU模式引导








